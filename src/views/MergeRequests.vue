<template>
  <div>
    <v-tabs v-model="activeTab" slider-color="orange">
      <v-tab key="open">
        Open
      </v-tab>
      <v-tab key="assigned">
        <v-badge right>
          <span slot="badge">{{assignedMergeRequestsSize}}</span>
          <span>Assigned to me</span>
        </v-badge>
      </v-tab>
      <v-tab key="merged" @click="fetchData('merged')">
        Merged
      </v-tab>
      <v-tab key="closed" @click="fetchData('closed')">
        Closed
      </v-tab>
      <v-btn v-show="activeTab < 2" class="ml-auto" color="red" @click="mergeAll(activeTab)" :loading="merging">
        Merge All
      </v-btn>
      <v-layout v-show="activeTab > 1" justify-end>
        <item-order-select v-model="mergeRequestsOrder" :options="mergeRequestsOrderOptions"/>
      </v-layout>
      <v-tab-item key="open">
        <template>
          <merge-requests :merge-requests="computedMergeRequests"/>
        </template>
      </v-tab-item>
      <v-tab-item key="assigned">
        <template>
          <merge-requests :merge-requests="assignedMergeRequests"/>
        </template>
      </v-tab-item>
      <v-tab-item key="merged">
        <template v-if="loaded">
          <merge-requests :merge-requests="mergeRequests" :order-option="mergeRequestsOrder"/>
        </template>
        <template v-else>
          <div class="text-xs-center pa-3">
            <v-progress-circular indeterminate></v-progress-circular>
          </div>
        </template>
      </v-tab-item>
      <v-tab-item key="closed">
        <template v-if="loaded">
          <merge-requests :merge-requests="mergeRequests" :order-option="mergeRequestsOrder"/>
        </template>
        <template v-else>
          <div class="text-xs-center pa-3">
            <v-progress-circular indeterminate></v-progress-circular>
          </div>
        </template>
      </v-tab-item>
    </v-tabs>
  </div>
</template>

<script>
import { mapGetters, mapState } from "vuex";
import gitlab from "@/gitlab";
import store from "@/store";
import ItemOrderSelect from "@/components/ItemOrderSelect.vue";
import MergeRequests from "@/components/MergeRequests.vue";

export default {
  data() {
    return {
      activeTab: null,
      loaded: false,
      merging: false,
      mergeRequests: null,
      mergeRequestsOrderOptions: [
        {
          label: "Last updated",
          field: "updated_at"
        },
        {
          label: "Created date",
          field: "created_at"
        }
      ],
      mergeRequestsOrder: {
        field: "updated_at",
        order: "desc"
      }
    };
  },
  computed: {
    ...mapGetters({
      computedMergeRequests: "getMergeRequests",
      assignedMergeRequests: "getAssignedMergeRequests"
    }),
    ...mapState({
      assignedMergeRequestsSize: state => state.merge_request.assignedMergeRequestsSize
    })
  },
  // TODO: need to fetch the right ones on mount or route change because if you come from a team you will get the team ones displayed here
  // even better: Have the current user in another state property to continuously watch them
  beforeRouteEnter(to, from, next) {
    store.dispatch("loadCurrentUser");
    next();
  },
  beforeRouteUpdate(to, from, next) {
    store.dispatch("loadCurrentUser");
    next();
  },
  methods: {
    fetchData(state /* closed OR merged */) {
      this.loaded = false;
      this.mergeRequests = [];
      gitlab
        .get()
        .client.fetchMergeRequests({ state })
        .then(mrs => (this.mergeRequests = mrs.data))
        .finally(() => (this.loaded = true));
    },

    mergeAll(activeTab) {
      const currMRs = activeTab === 0 ? this.computedMergeRequests : this.assignedMergeRequests;
      const canBeMerged = (currMRs || []).filter(mr => mr.merge_status === "can_be_merged");

      this.merging = true;
      Promise.all([
          canBeMerged.reduce((promise, mr) =>
          promise.then(() =>
            this.$store
              .dispatch("merge", mr)
              .then(() => {})
              .catch(() => {})
        ), Promise.resolve())
      ]).finally(() => (this.merging = false));
    }
  },
  components: {
    ItemOrderSelect,
    MergeRequests
  }
};
</script>
